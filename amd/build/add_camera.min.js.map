{"version":3,"sources":["../src/add_camera.js"],"names":["define","$","str","ModalFactory","Camera","cmid","mainimage","attemptid","docElement","document","video","getElementById","videoid","canvas","canvasid","on","showpopup","bind","setTimeout","navigator","mediaDevices","getUserMedia","audio","then","stream","srcObject","play","catch","prototype","width","height","takepictureid","retakeid","takepicture","context","getContext","drawImage","data","toDataURL","hide","show","val","ajax","url","M","cfg","wwwroot","method","imgBase64","success","response","errorcode","trigger","get_string","proctoringimage","retake","event","message","create","body","modal","init","verifyduringattempt","setinterval","attr","id","appendTo","autoplay","camera","setInterval","e","preventDefault"],"mappings":"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","sourcesContent":["/**\n * JavaScript class for Camera\n *\n * @package    quizaccess\n * @subpackage proctoring\n * @copyright  2020 Mahendra Soni <ms@taketwotechnologies.com> {@link https://taketwotechnologies.com}\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/str', 'core/modal_factory'],\nfunction($, str, ModalFactory) {\n    var Camera = function(cmid, mainimage=false, attemptid=null) {\n       // console.log(cmid, mainimage, attemptid);\n        var docElement = $(document);\n        this.video = document.getElementById(this.videoid);\n        this.canvas = document.getElementById(this.canvasid);\n        this.cmid = cmid;\n        this.mainimage = mainimage;\n        this.attemptid = attemptid;\n        docElement.on('popup', this.showpopup.bind(this));\n        setTimeout(navigator.mediaDevices.getUserMedia({ video: true, audio: false })\n            .then(function(stream) {\n                if (this.video) {\n                  this.video.srcObject = stream;\n                  this.video.play();\n                }\n            })\n        .catch(function() {\n            //console.log(err);\n        }), 10000);\n    };\n    /** @type Tag element contain video. */\n    Camera.prototype.video = false;\n    /** @type String video elemend id. */\n    Camera.prototype.videoid = 'video';\n    /** @type Tag element contain canvas. */\n    Camera.prototype.canvas = false;\n    /** @type String video elemend id. */\n    Camera.prototype.canvasid = 'canvas';\n    /** @type int width of canvas object. */\n    Camera.prototype.width = 320;\n    /** @type int width of canvas object. */\n    Camera.prototype.height = 240;\n    /** @type String element contain takepicture button. */\n    Camera.prototype.takepictureid = 'takepicture';\n    /** @type String element contain retake button. */\n    Camera.prototype.retakeid = 'retake';\n    /** @type int course module id. */\n    Camera.prototype.cmid = false;\n    /** @type bool whether a main image or compare against an image. */\n    Camera.prototype.mainimage = false;\n     /** @type int attempt id. */\n     Camera.prototype.attemptid = false;\n\n    Camera.prototype.takepicture = function() {\n        //console.log('takepicture function');\n        var context = this.canvas.getContext('2d');\n        context.drawImage(this.video, 0, 0, this.width, this.height);\n        var data = this.canvas.toDataURL('image/png');\n        $('#'+this.videoid).hide();\n        $('#'+this.takepictureid).hide();\n        $('#'+this.canvasid).show();\n        $('#'+this.retakeid).show();\n        $(\"input[name='userimg']\").val(data);\n        $.ajax({\n            url : M.cfg.wwwroot + '/mod/quiz/accessrule/proctoring/ajax.php',\n            method : 'POST',\n            data : {imgBase64: data, cmid: this.cmid,attemptid: this.attemptid, mainimage: this.mainimage},\n            success : function(response) {\n                if (response && response.errorcode) {\n                    //console.log(response.errorcode);\n                    $(document).trigger('popup', str.get_string(response.errorcode, 'quizaccess_proctoring'));\n                }\n            }\n        });\n    };\n    Camera.prototype.proctoringimage = function() {\n        //console.log(this.cmid);\n        var context = this.canvas.getContext('2d');\n        context.drawImage(this.video, 0, 0, this.width, this.height);\n        var data = this.canvas.toDataURL('image/png');\n        $.ajax({\n            url : M.cfg.wwwroot + '/mod/quiz/accessrule/proctoring/ajax.php',\n            method : 'POST',\n            data : {imgBase64: data, cmid: this.cmid, attemptid: this.attemptid,mainimage: this.mainimage},\n            success : function(response){\n                if (response && response.errorcode) {\n                   // console.log(response.errorcode);\n                    $(document).trigger('popup', str.get_string(response.errorcode, 'quizaccess_proctoring'));\n                }\n            }\n        });\n    };\n\n    Camera.prototype.retake = function() {\n        $('#'+this.videoid).show(this.cmid);\n        $('#'+this.takepictureid).show();\n        $('#'+this.canvasid).hide();\n        $('#'+this.retakeid).hide();\n    };\n    Camera.prototype.showpopup = function(event, message) {\n        ModalFactory.create({\n            body: message,\n        }).then(function(modal) {\n            modal.show();\n        });\n    };\n    var init = function(cmid, mainimage, verifyduringattempt = false, attemptid=null,setinterval=5) {\n        if (verifyduringattempt) {\n            $('<canvas>').attr({id: 'canvas', 'style': 'display: none;'}).appendTo('body');\n            $('<video>').attr({id: 'video', width: '320', height: '240', autoplay: 'autoplay'}).appendTo('body');\n            var camera = new Camera(cmid, mainimage, attemptid);\n            setInterval(camera.proctoringimage.bind(camera), setinterval * 60 * 1000);\n        } else {\n            var camera = new Camera(cmid, mainimage, attemptid);\n            // Take picture on button click\n            $('#'+camera.takepictureid).on('click', function(e) {\n                e.preventDefault();\n                camera.takepicture();\n            });\n            // Show video again when retake\n            $('#'+camera.retakeid).on('click', function(e) {\n                e.preventDefault();\n                camera.retake();\n            });\n        }\n    };\n    return {\n        init: init\n    };\n});\n"],"file":"add_camera.min.js"}